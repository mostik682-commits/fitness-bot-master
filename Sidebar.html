<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* –ü–û–í–ï–†–ù–£–õ–ò –°–¢–ê–†–ò–ô, –ó–†–û–ó–£–ú–Ü–õ–ò–ô –î–ò–ó–ê–ô–ù */
      body { font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; background-color: #f8f9fa; color: #333; }
      .tabs { display: flex; background: #fff; border-bottom: 1px solid #ddd; padding: 0 10px; position: sticky; top: 0; z-index: 10; }
      .tab { flex: 1; text-align: center; padding: 12px 0; cursor: pointer; font-weight: 600; color: #777; font-size: 12px; border-bottom: 3px solid transparent; }
      .tab.active { color: #2e7d32; border-bottom-color: #2e7d32; }
      .tab.run-active { color: #1976D2; border-bottom-color: #1976D2; }
      
      .container { padding: 12px; }
      .hidden { display: none !important; }
      .card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
      h3 { margin: 0 0 10px 0; font-size: 13px; color: #555; font-weight: 700; text-transform: uppercase; }
      
      /* –°—Ç–∞—Ä—ñ –∫–æ–ª—å–æ—Ä–∏ –±–ª–æ–∫—ñ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
      .run-stats-box-global { margin-top: 20px; padding: 15px; background: #E3F2FD; border-radius: 8px; border-left: 4px solid #2196F3; font-size: 12px; color: #0D47A1; }
      .global-stats-box { margin-top: 20px; padding: 15px; background: #eceff1; border-radius: 8px; border-left: 4px solid #607d8b; font-size: 12px; color: #37474f; }
      .gs-row { margin-bottom: 6px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 4px; }
      .gs-val { font-weight: 800; color: #263238; }

      .run-stats-box { display: flex; justify-content: space-around; margin-bottom: 15px; background: #f1f8e9; padding: 10px; border-radius: 6px; }
      .rs-item { text-align: center; }
      .rs-val { display: block; font-size: 18px; font-weight: 800; color: #1976D2; }
      .rs-lbl { font-size: 10px; color: #666; text-transform: uppercase; }

      table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 5px; }
      th { text-align: left; background: #f5f5f5; padding: 5px; color: #888; font-weight: 600; }
      td { border-bottom: 1px solid #eee; padding: 8px 5px; vertical-align: middle; }
      /* –û–Ω–æ–≤–ª–µ–Ω–∏–π —à—Ä–∏—Ñ—Ç —Ç–∞ –∫–æ–ª—ñ—Ä –¥–ª—è –í–∞–≥–∏ (—è–∫ –ö–∞–ª–æ—Ä—ñ—ó/–í—É–≥–ª–µ–≤–æ–¥–∏) */
val-col { 
  font-family: 'Inter', sans-serif; 
  font-weight: 800; 
  color: #4285F4; 
  font-size: 13px; /* –û–¥–Ω–∞–∫–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä */
}

/* –°—Ç–∏–ª—ñ –¥–ª—è –ø—ñ–¥—Ö–æ–¥—ñ–≤ —Ç–∞ –ø–æ–≤—Ç–æ—Ä—ñ–≤ (—è–∫ –ë —Ç–∞ –ñ) */
.sets-val { 
  font-family: 'Inter', sans-serif; 
  font-weight: 800; 
  color: #EA4335; 
  font-size: 13px; /* –û–¥–Ω–∞–∫–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä */
}

.reps-val { 
  font-family: 'Inter', sans-serif; 
  font-weight: 800; 
  color: #FBBC05; 
  font-size: 13px; /* –û–¥–Ω–∞–∫–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä */
}

.x-mark { 
  color: #BDC1C6; 
  margin: 0 4px; 
  font-size: 11px; 
}

/* –î–∞—Ç–∞ —Ç–∞–∫–æ–∂ 13px –¥–ª—è –æ–¥–Ω–∞–∫–æ–≤–æ—Å—Ç—ñ */
#histTable td {
  font-size: 13px;
}
      
      .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4CAF50; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 40px auto; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  </head>
  <body>

    <div class="tabs" id="tabContainer"></div>
    <div id="loader" class="loader"></div>
    <div id="emptyState" style="text-align:center; color:#999; margin-top:50px; font-size:13px;" class="hidden">üëà –ö–ª—ñ–∫–Ω–∏ –Ω–∞ –≤–ø—Ä–∞–≤—É</div>

    <div id="content" class="container hidden">
      <div class="card">
        <h3 id="exName">...</h3>
        
        <div id="runStatsPanel" class="hidden">
           <div class="run-stats-box">
              <div class="rs-item"><span class="rs-val" id="totalKm">0</span><span class="rs-lbl">–í—Å—å–æ–≥–æ –ö–ú</span></div>
              <div class="rs-item">
  <span class="rs-val" id="currentIntensity" style="font-size: 14px;">0%</span>
  <span class="rs-lbl">–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å</span>
</div>
           </div>
           
           <div style="height: 140px; position: relative;">
              <canvas id="zoneChart"></canvas>
           </div>
           <div id="gaugeLabel" style="text-align: center; font-weight: 800; font-size: 20px; margin-top: -10px; margin-bottom: 20px; color: #333;">0%</div>
        </div>
        
        <canvas id="mainChart" width="250" height="150"></canvas>
      </div>

      <div class="card">
        <h3>–Ü—Å—Ç–æ—Ä—ñ—è</h3>
        <table id="histTable">
          <thead><tr id="tableHead"></tr></thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>

      <div id="globalTonnage" class="hidden"></div>
    </div>
    
    <div id="inventoryView" class="container hidden">
      <div class="card"><h3>–Ü–Ω–≤–µ–Ω—Ç–∞—Ä</h3><div id="invList">...</div></div>
    </div>

    <script>
      var currentMode = 'strength';
      var activeTab = 'main';
      var myChart = null; 
      var zChart = null;
      var isFirstLoad = true;
      var lastDataHash = "";

      Chart.defaults.devicePixelRatio = window.devicePixelRatio || 1;

      setInterval(checkSelection, 1500);

      function checkSelection() {
        if(activeTab !== 'inv') {
          google.script.run
            .withSuccessHandler(onData)
            .withFailureHandler(function(e){ console.log(e); })
            .getSelectedExerciseData();
        }
      }

      function onData(res) {
        if (isFirstLoad) { 
          document.getElementById('loader').classList.add('hidden'); 
          isFirstLoad = false; 
        }

        if (res.status === "success") {
          // üî• –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –¥–∞–Ω—ñ –∑–º—ñ–Ω–∏–ª–∏—Å—å –ø–æ –Ω–∞–∑–≤—ñ –≤–ø—Ä–∞–≤–∏
          var newHash = res.name + "_" + (res.currentIntensity || 0) + "_" + (res.history ? res.history.length : 0);
          if (newHash === lastDataHash) return;
          lastDataHash = newHash;
          
          document.getElementById('content').classList.remove('hidden');
          document.getElementById('emptyState').classList.add('hidden');
          if (currentMode !== res.type) { currentMode = res.type; renderTabs(); }
          renderUI(res);
        } else {
          document.getElementById('content').classList.add('hidden');
          document.getElementById('emptyState').classList.remove('hidden');
        }
      }

     function renderUI(res) {
  document.getElementById('exName').innerText = res.name;
  var g = res.globalStats;

  if (res.type === 'run') {
     document.getElementById('runStatsPanel').classList.remove('hidden');
     
     var currentInt = res.currentIntensity || (res.history.length > 0 ? res.history[res.history.length - 1].intensity : 0);
     
     var totalKm = res.runStats.totalKm;
     if (totalKm === 0 && res.history.length > 0) {
        totalKm = res.history.reduce((sum, item) => sum + item.distance, 0).toFixed(2);
     }

     document.getElementById('totalKm').innerText = totalKm;
     document.getElementById('currentIntensity').innerText = res.displayText || (currentInt + "%");
     renderZoneChart(res.runStats.zones, currentInt);

     var labels = res.history.map(i => i.label);
     var data = res.history.map(i => i.distance);
     renderLineChart(labels, data, "–î–∏—Å—Ç–∞–Ω—Ü—ñ—è (–∫–º)", "#1976D2");

     renderTable(["–î–∞—Ç–∞", "–Ü–Ω—Ç–µ–Ω—Å.", "–î–∏—Å—Ç–∞–Ω—Ü—ñ—è"], res.history, (i) => {
       return `<td>${i.label}</td><td class="val-col" style="color:#e65100; font-weight:bold;">${i.intensity}%</td><td>${i.rawDist}</td>`;
     });

     var statsBox = document.getElementById('globalTonnage');
     statsBox.className = "run-stats-box-global"; 
     statsBox.classList.remove('hidden');
     
     if (g) {
       statsBox.innerHTML = `
         <div style="font-weight:bold; margin-bottom:10px; color:#1565C0;">üèÉ‚Äç‚ôÇÔ∏è –û–ë–°–Ø–ì–ò –ë–Ü–ì–£ (–ö–ú):</div>
         <div class="gs-row"><span>–ó–∞ —Å—å–æ–≥–æ–¥–Ω—ñ (${g.dLabel}):</span> <span class="gs-val">${g.day} –∫–º</span></div>
         <div class="gs-row"><span>–ó–∞ —Ç–∏–∂–¥–µ–Ω—å (${g.wLabel}):</span> <span class="gs-val">${g.week} –∫–º</span></div>
         <div class="gs-row" style="border-bottom:2px solid #90CAF9; margin-bottom:10px;"><span>–ó–∞ —Ü–∏–∫–ª (${g.cLabel}):</span> <span class="gs-val">${g.cycle} –∫–º</span></div>
         
         <div style="font-size:11px; color:#555; margin-bottom:5px;">üëá <b>–†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ —Ü–∏–∫–ª (${g.cLabel}):</b></div>
         <div class="gs-row"><span>–¥–æ 50%</span> <span class="gs-val">${g.cycleZones.Z1} –∫–º</span></div>
         <div class="gs-row"><span>51-70%</span> <span class="gs-val">${g.cycleZones.Z2} –∫–º</span></div>
         <div class="gs-row"><span>71-80%</span> <span class="gs-val">${g.cycleZones.Z3} –∫–º</span></div>
         <div class="gs-row"><span>81-90%</span> <span class="gs-val">${g.cycleZones.Z4} –∫–º</span></div>
         <div class="gs-row"><span>91-100%</span> <span class="gs-val">${g.cycleZones.Z5} –∫–º</span></div>
       `;
     }
  } else {
     // –ë–õ–û–ö –î–õ–Ø –°–ò–õ–û–í–ò–•
     document.getElementById('runStatsPanel').classList.add('hidden');
     
     var statsBox = document.getElementById('globalTonnage');
     statsBox.className = "global-stats-box";
     statsBox.classList.remove('hidden');
     
     if (g) {
       statsBox.innerHTML = `
         <div class="gs-row"><span>–ó–∞–≥–∞–ª—å–Ω–∏–π —Ç–æ–Ω–∞–∂ ${g.dLabel}</span> <span class="gs-val">${g.day.toLocaleString()} –∫–≥</span></div>
         <div class="gs-row"><span>–ó–∞–≥–∞–ª—å–Ω–∏–π —Ç–æ–Ω–∞–∂ ${g.wLabel}</span> <span class="gs-val">${g.week.toLocaleString()} –∫–≥</span></div>
         <div class="gs-row"><span>–ó–∞–≥–∞–ª—å–Ω–∏–π —Ç–æ–Ω–∞–∂ ${g.cLabel}</span> <span class="gs-val">${g.cycle.toLocaleString()} –∫–≥</span></div>
       `;
     }
     
     var labels = res.history.map(i => i.label);
     var data = res.history.map(i => i.weight === "Bodyweight" ? 0 : i.weight);
     renderLineChart(labels, data, "–í–∞–≥–∞ (–∫–≥)", "#4285F4");
     
     renderTable(["–î–∞—Ç–∞", "–í–∞–≥–∞", "–ü—ñ–¥—Ö/–ü–æ–≤—Ç"], res.history, (i) => {
  var valText = i.displayText || (i.weight + " –∫–≥");
  
  // –ö–æ–ª—å–æ—Ä–æ–≤–∏–π –∑–∞–ø–∏—Å: –í–∞–≥–∞(–°–∏–Ω—ñ–π), –ü—ñ–¥—Ö–æ–¥–∏(–ß–µ—Ä–≤–æ–Ω–∏–π), –ü–æ–≤—Ç–æ—Ä–∏(–ñ–æ–≤—Ç–∏–π)
  return `
    <td>${i.label}</td>
    <td class="val-col">${valText}</td>
    <td>
      <span class="sets-val">${i.sets}</span>
      <span class="x-mark">x</span>
      <span class="reps-val">${i.reps}</span>
    </td>
  `;
});
  }
}

      function renderZoneChart(zones, currentInt) {
        var ctx = document.getElementById('zoneChart').getContext('2d');
        if(zChart) zChart.destroy();
        
        var zoneColors = ['#A5D6A7', '#4FC3F7', '#FFEE58', '#FFA726', '#EF5350'];
        document.getElementById('gaugeLabel').innerText = currentInt + "%";

        zChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ["–¥–æ 50%", "51-70%", "71-80%", "81-90%", "91-100%"], 
            datasets: [{ data: [20, 20, 20, 20, 20], backgroundColor: zoneColors, borderWidth: 2, borderColor: '#ffffff', circumference: 180, rotation: 270, cutout: '80%' }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            layout: { padding: { top: 10, bottom: 0, left: 15, right: 15 } },
            plugins: { legend: { display: false }, tooltip: { enabled: false } }
          },
          plugins: [{
            id: 'gaugeNeedle',
            afterDraw: (chart) => {
              var { ctx, chartArea: { width } } = chart;
              ctx.save();
              
              var meta = chart.getDatasetMeta(0);
              var centerX = meta.data[0].x;
              var centerY = meta.data[0].y;
              var outerRadius = meta.data[0].outerRadius;
              
              var needleValue = currentInt > 100 ? 100 : currentInt;
              var angle = Math.PI + (needleValue / 100) * Math.PI;
              
              ctx.translate(centerX, centerY);
              ctx.rotate(angle);
              
              ctx.beginPath();
              ctx.moveTo(0, -3);
              ctx.lineTo(outerRadius - 5, 0); 
              ctx.lineTo(0, 3);
              ctx.fillStyle = '#333';
              ctx.fill();
              
              ctx.beginPath();
              ctx.arc(0, 0, 5, 0, Math.PI * 2);
              ctx.fill();
              ctx.restore();
            }
          }]
        });
      }

      function renderTabs() {
        var html = "";
        var clsMain = (currentMode === 'run') ? 'tab run-active' : 'tab active';
        var def = 'tab';
        
        html += `<div class="${activeTab==='main'?clsMain:def}" onclick="swTab('main')">${currentMode === 'run' ? 'üèÉ –ë—ñ–≥' : 'üèãÔ∏è‚Äç‚ôÇÔ∏è KG'}</div>`;
        
        var clsInv = (activeTab === 'inv') ? 'tab active' : 'tab'; 
        html += `<div class="${clsInv}" onclick="swTab('inv')">üéí –Ü–Ω–≤–µ–Ω—Ç–∞—Ä</div>`;
        
        document.getElementById('tabContainer').innerHTML = html;
      }

      function swTab(t) {
        activeTab = t; 
        renderTabs();
        
        document.getElementById('content').classList.add('hidden');
        document.getElementById('inventoryView').classList.add('hidden');

        if(t === 'main') {
           document.getElementById('content').classList.remove('hidden');
        } 
        else if (t === 'inv') { 
           document.getElementById('inventoryView').classList.remove('hidden'); 
           loadInv();
        } 
      }

      function renderLineChart(lbls, data, label, color) {
  var ctx = document.getElementById('mainChart').getContext('2d');
  if(myChart) myChart.destroy();
  myChart = new Chart(ctx, {
    type: 'line', 
    data: { 
      labels: lbls, 
      datasets: [{ 
        label: label, 
        data: data, 
        borderColor: color, 
        backgroundColor: color === "#4285F4" ? "rgba(66, 133, 244, 0.1)" : color+"33", 
        tension: 0.4, // –ù–∞—Ç—è–≥ —è–∫ —É —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—ñ
        fill: true, 
        pointRadius: 5,
        pointBackgroundColor: color,
        pointBorderColor: "#fff",
        pointBorderWidth: 2
      }] 
    },
    options: { 
      responsive: true, 
      plugins: { legend: {display: false} }, 
      scales: { 
        x: { display: false },
        y: { grid: { color: "#f0f0f0" }, ticks: { font: {size: 10}, color: "#999" } }
      } 
    }
  });
}

      function renderTable(headers, data, rowFn) {
  document.getElementById('tableHead').innerHTML = headers.map(h => `<th>${h}</th>`).join(""); 
  document.getElementById('histBody').innerHTML = data.map(i => `<tr>${rowFn(i)}</tr>`).join("");
}

      function loadInv() {
        document.getElementById('invList').innerHTML = '<div style="text-align:center; padding:20px;"><div class="loader" style="width:20px;height:20px;margin:0 auto;"></div></div>';
        
        google.script.run
          .withSuccessHandler(function(res) {
            var container = document.getElementById('invList');
            
            if (res.error) {
              container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">‚ùå ' + res.error + '</div>';
              return;
            }
            
            var html = '<div style="text-align:center; padding:10px 0 15px;">' +
              '<span style="font-size:13px; color:#888;">üë§ ' + res.clientName + '</span>' +
            '</div>';
            
            if (!res.inventory || res.inventory.length === 0) {
              html += '<div style="text-align:center; color:#999; padding:30px 15px; font-size:13px;">‚ö†Ô∏è –Ü–Ω–≤–µ–Ω—Ç–∞—Ä –ø–æ—Ä–æ–∂–Ω—ñ–π.<br>–í—ñ–¥–º—ñ—Ç—å—Ç–µ –≥–∞–ª–æ—á–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—ñ users.</div>';
            } else {
              for (var i = 0; i < res.inventory.length; i++) {
                html += '<div style="display:flex; align-items:center; padding:12px 15px; margin-bottom:8px; background:#f8f9fa; border-radius:10px; border:1px solid #eee;">' +
                  '<span style="font-size:18px; margin-right:12px;">‚úÖ</span>' +
                  '<span style="font-size:15px; font-weight:600; color:#333;">' + res.inventory[i] + '</span>' +
                '</div>';
              }
            }
            
            container.innerHTML = html;
          })
          .withFailureHandler(function(err) {
            document.getElementById('invList').innerHTML = '<div style="text-align:center; color:#999; padding:20px;">‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
          })
          .getInventoryForUser();
      }
    </script>
  </body>
</html>