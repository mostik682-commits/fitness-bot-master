<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .progress-container { width: 100%; height: 6px; background-color: #f0f0f0; position: fixed; top: 0; left: 0; z-index: 100; }
    .progress-bar { height: 100%; background-color: #2b9e2e; width: 0%; transition: width 0.3s ease; }

    .container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }

    .step { display: none; width: 100%; max-width: 400px; animation: fadeIn 0.4s ease; }
    .step.active { display: block; }

    h2 { font-size: 22px; margin-bottom: 8px; text-align: center; font-weight: 700; }
    p.desc { color: #888; text-align: center; margin-bottom: 20px; font-size: 14px; }

    input[type="text"], input[type="number"], textarea {
      width: 100%; padding: 16px; border: 1px solid #e0e0e0; border-radius: 12px;
      box-sizing: border-box; font-size: 16px; background-color: #fafafa;
      color: #000; outline: none; transition: all 0.2s;
    }
    input:focus, textarea:focus { border-color: #3390ec; background-color: #fff; }

    .option-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
    .option-card {
      padding: 14px 16px; border: 2px solid #f0f0f0; border-radius: 12px;
      font-size: 15px; font-weight: 500; cursor: pointer; background-color: #fff;
      transition: all 0.2s ease;
    }
    .option-card:hover { border-color: #b0d4f1; }
    .option-card.selected {
      border-color: #3390ec; background-color: #3390ec; color: white;
      box-shadow: 0 4px 12px rgba(51, 144, 236, 0.3);
    }

    .custom-input-wrapper { margin-top: 12px; display: none; }
    .custom-input-wrapper.visible { display: block; }
    .custom-input-wrapper input, .custom-input-wrapper textarea {
      background: #f9f9f9;
    }

    .btn-container { display: flex; gap: 12px; margin-top: 25px; }
    button { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    .btn-next { background-color: #3390ec; color: #fff; }
    .btn-back { background-color: #f0f0f0; color: #333; }
    .btn-submit { background-color: #2b9e2e; color: #fff; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .error-msg { color: #e53935; font-size: 13px; margin-top: 8px; text-align: center; min-height: 18px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    #successView { text-align: center; display: none; flex-direction: column; justify-content: center; align-items: center; height: 100vh; }
    #loadingView { text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f0f0f0; border-top-color: #3390ec; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <script>var PASSED_ID = "<?= serverUserId ?>";</script>

  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>

  <!-- Завантаження -->
  <div id="loadingView">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: #888;">Завантаження анкети...</p>
  </div>

  <!-- Форма (генерується динамічно) -->
  <div class="container hidden" id="formContainer"></div>

  <!-- Успіх -->
  <div id="successView">
    <div style="font-size: 70px;">✅</div>
    <h3>Успішно!</h3>
    <p>Анкету відправлено тренеру.</p>
  </div>

  <script>
    var tg = window.Telegram.WebApp;
    tg.ready(); 
    tg.expand();

    var questions = [];
    var totalSteps = 0;
    var currentStep = 1;
    var answers = {};

    // Завантажуємо питання з сервера
    google.script.run
      .withSuccessHandler(onQuestionsLoaded)
      .withFailureHandler(onLoadError)
      .getAnketaQuestions();

    function onLoadError(err) {
      document.getElementById('loadingView').innerHTML = 
        '<div style="color: #e53935; padding: 20px;">❌ Помилка завантаження: ' + err.message + '</div>';
    }

    function onQuestionsLoaded(result) {
      if (result.status !== "success") {
        onLoadError({ message: result.msg });
        return;
      }

      questions = result.questions;
      totalSteps = questions.length;
      
      buildForm();
      
      document.getElementById('loadingView').style.display = 'none';
      document.getElementById('formContainer').classList.remove('hidden');
      
      showStep(1);
    }

    function buildForm() {
      var container = document.getElementById('formContainer');
      var html = '';

      for (var i = 0; i < questions.length; i++) {
        var q = questions[i];
        var stepNum = i + 1;
        var isLast = (stepNum === totalSteps);

        html += '<div class="step" id="step' + stepNum + '">';
        html += '<h2>' + q.text + '</h2>';
        html += '<p class="desc">Крок ' + stepNum + ' з ' + totalSteps + '</p>';

        // Генеруємо поля в залежності від типу
        if (q.type === 'text') {
          // Просто текстове поле
          html += '<input type="text" id="' + q.id + '" placeholder="Введіть відповідь...">';
        } 
        else if (q.type === 'select') {
          // Тільки вибір з варіантів
          html += '<input type="hidden" id="' + q.id + '">';
          html += '<div class="option-list" id="options_' + q.id + '">';
          for (var j = 0; j < q.options.length; j++) {
            html += '<div class="option-card" onclick="selectOption(\'' + q.id + '\', \'' + escapeHtml(q.options[j]) + '\', this)">' + q.options[j] + '</div>';
          }
          html += '</div>';
        }
        else if (q.type === 'combo') {
          // Вибір + можливість своєї відповіді
          html += '<input type="hidden" id="' + q.id + '">';
          html += '<div class="option-list" id="options_' + q.id + '">';
          for (var j = 0; j < q.options.length; j++) {
            html += '<div class="option-card" onclick="selectOption(\'' + q.id + '\', \'' + escapeHtml(q.options[j]) + '\', this)">' + q.options[j] + '</div>';
          }
          html += '</div>';
          html += '<div class="custom-input-wrapper" id="custom_' + q.id + '">';
          html += '<input type="text" id="custom_input_' + q.id + '" placeholder="Або напишіть свій варіант..." oninput="onCustomInput(\'' + q.id + '\')">';
          html += '</div>';
        }

        html += '<div class="error-msg" id="err' + stepNum + '"></div>';
        html += '<div class="btn-container">';
        
        if (stepNum > 1) {
          html += '<button class="btn-back" onclick="prevStep()">Назад</button>';
        }
        
        if (isLast) {
          html += '<button class="btn-submit" id="btnSubmit" onclick="submitForm()">✅ Надіслати</button>';
        } else {
          html += '<button class="btn-next" onclick="nextStep()">Далі</button>';
        }
        
        html += '</div>';
        html += '</div>';
      }

      container.innerHTML = html;

      // Показуємо поля "Власна відповідь" для combo типів
      for (var i = 0; i < questions.length; i++) {
        if (questions[i].type === 'combo') {
          document.getElementById('custom_' + questions[i].id).classList.add('visible');
        }
      }
    }

    function escapeHtml(text) {
      return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    function selectOption(inputId, value, element) {
      document.getElementById(inputId).value = value;
      
      // Знімаємо виділення з усіх
      var parent = element.parentNode;
      var cards = parent.getElementsByClassName('option-card');
      for (var i = 0; i < cards.length; i++) {
        cards[i].classList.remove('selected');
      }
      element.classList.add('selected');

      // Очищуємо кастомне поле якщо вибрали варіант
      var customInput = document.getElementById('custom_input_' + inputId);
      if (customInput) {
        customInput.value = '';
      }
    }

    function onCustomInput(inputId) {
      var customValue = document.getElementById('custom_input_' + inputId).value.trim();
      
      if (customValue) {
        // Записуємо кастомне значення
        document.getElementById(inputId).value = customValue;
        
        // Знімаємо виділення з карток
        var optionsDiv = document.getElementById('options_' + inputId);
        if (optionsDiv) {
          var cards = optionsDiv.getElementsByClassName('option-card');
          for (var i = 0; i < cards.length; i++) {
            cards[i].classList.remove('selected');
          }
        }
      }
    }

    function updateProgress() {
      var percent = ((currentStep - 1) / (totalSteps - 1)) * 100;
      if (currentStep === 1) percent = 5;
      if (currentStep === totalSteps) percent = 100;
      document.getElementById('progressBar').style.width = percent + '%';
    }

    function showStep(stepNum) {
      var steps = document.getElementsByClassName('step');
      for (var i = 0; i < steps.length; i++) {
        steps[i].classList.remove('active');
      }
      document.getElementById('step' + stepNum).classList.add('active');
      currentStep = stepNum;
      updateProgress();
    }

    function nextStep() {
      var q = questions[currentStep - 1];
      var errDiv = document.getElementById('err' + currentStep);
      errDiv.innerText = '';

      var value = document.getElementById(q.id).value.trim();
      
      if (!value || value.length < 1) {
        errDiv.innerText = 'Будь ласка, дайте відповідь';
        return;
      }

      answers[q.id] = value;
      showStep(currentStep + 1);
    }

    function prevStep() {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    }

    function submitForm() {
      // Зберігаємо останню відповідь
      var q = questions[currentStep - 1];
      var value = document.getElementById(q.id).value.trim();
      
      if (!value || value.length < 1) {
        document.getElementById('err' + currentStep).innerText = 'Будь ласка, дайте відповідь';
        return;
      }
      answers[q.id] = value;

      // Перевіряємо ID
      if (!PASSED_ID || PASSED_ID === "NOT_FOUND") {
        document.getElementById('err' + currentStep).innerText = 'Помилка: ID не передано. Перезапусти бота.';
        return;
      }

      var btn = document.getElementById('btnSubmit');
      btn.disabled = true;
      btn.innerText = 'Відправка...';

      // Формуємо дані для відправки
      var formData = {
        telegramId: PASSED_ID,
        answers: answers,
        questions: questions.map(function(q) { return q.text; })
      };

      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('formContainer').style.display = 'none';
          document.getElementById('successView').style.display = 'flex';
          setTimeout(function() { tg.close(); }, 2500);
        })
        .withFailureHandler(function(e) {
          document.getElementById('err' + currentStep).innerText = 'Помилка: ' + e.message;
          btn.disabled = false;
          btn.innerText = '✅ Надіслати';
        })
        .processAnketaDataDynamic(formData);
    }
  </script>
</body>
</html>